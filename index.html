<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CCU Fuel Dispatch</title>
    <style>
        :root { --primary: #0a3d62; --accent: #3c6382; --bg: #dfe6e9; --card: #ffffff; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #2d3436; }
        
        .container { max-width: 500px; margin: 0 auto; background: var(--card); padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary); margin: 0 0 5px 0; text-transform: uppercase; font-size: 1.5rem; }
        .sub { text-align: center; color: #636e72; font-size: 0.85rem; margin-bottom: 25px; }

        /* INPUTS */
        .input-group { display: flex; gap: 15px; margin-bottom: 15px; }
        .input-col { flex: 1; }
        label { font-size: 0.7rem; font-weight: 800; color: #b2bec3; text-transform: uppercase; display: block; margin-bottom: 5px; }
        input[type="text"] { width: 100%; padding: 12px; border: 2px solid #dfe6e9; border-radius: 8px; font-size: 1.2rem; font-weight: 800; text-align: center; text-transform: uppercase; box-sizing: border-box; }
        input:focus { border-color: var(--accent); outline: none; }

        /* SLIDER SECTION */
        .slider-container { background: #f1f2f6; padding: 20px; border-radius: 12px; margin-top: 20px; border: 1px solid #e1e1e1; }
        .slider-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .slider-val { font-size: 1.2rem; font-weight: 800; color: var(--primary); }
        
        input[type=range] { -webkit-appearance: none; width: 100%; height: 8px; background: #d3d3d3; border-radius: 5px; outline: none; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 25px; height: 25px; border-radius: 50%; background: var(--primary); cursor: pointer; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* BUTTON */
        button { width: 100%; padding: 18px; margin-top: 25px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
        button:hover { background: #0c2461; transform: translateY(-2px); }

        /* RESULT */
        #result { display: none; margin-top: 30px; border-top: 2px dashed #b2bec3; padding-top: 20px; text-align: center; }
        .uplift-display { font-size: 4rem; font-weight: 800; line-height: 1; color: var(--primary); }
        .uplift-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; color: #636e72; }
        
        .details { display: flex; justify-content: space-between; margin-top: 20px; background: #f1f2f6; padding: 15px; border-radius: 8px; }
        .d-item div:first-child { font-size: 0.7rem; color: #636e72; font-weight: 700; }
        .d-item div:last-child { font-size: 1.1rem; font-weight: 800; color: #2d3436; }

        /* BADGES */
        .badge { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; color: white; margin-left: 5px; vertical-align: middle; }
        .cheap { background: #00b894; }
        .exp { background: #d63031; }
    </style>
</head>
<body>

<div class="container">
    <h1>⛽ CCU Dispatch</h1>
    <p class="sub">Uplift Calculator • A320/B737 Operations</p>
    
    <div class="input-group">
        <div class="input-col">
            <label>Inbound From</label>
            <input type="text" id="prev" placeholder="DEL" onchange="autoAdjustSlider()">
        </div>
        <div class="input-col">
            <label>Destination</label>
            <input type="text" id="next" placeholder="BOM">
        </div>
    </div>

    <div class="slider-container">
        <div class="slider-top">
            <label style="margin:0; color:#2d3436;">Fuel On Board (Arrival)</label>
            <span id="fob-val" class="slider-val">3000 kg</span>
        </div>
        <input type="range" id="fob" min="1000" max="8000" step="100" value="3000" oninput="updateLabel(this.value)">
        <div id="slider-msg" style="font-size:0.7rem; color:#636e72; margin-top:8px; font-style:italic; text-align:right;">Manual Override</div>
    </div>

    <button onclick="calculate()">GET UPLIFT FIGURE</button>

    <div id="result">
        <div class="uplift-label">REQUIRED UPLIFT</div>
        <div id="uplift" class="uplift-display">0 kg</div>

        <div class="details">
            <div class="d-item">
                <div>BLOCK FUEL REQ</div>
                <div id="block">0 kg</div>
            </div>
            <div class="d-item">
                <div>TRIP DIST</div>
                <div id="dist">0 km</div>
            </div>
            <div class="d-item">
                <div>TANKERING</div>
                <div id="tanker">NO</div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const SHEET_URL = "airports.csv";
    const BASE_PRICE = 90; 
    const DEFAULT_TAX = 4;

    // Aircraft: A320 (Calibrated to your feedback)
    const AC = { 
        burn: 4.2,     // High burn for short sectors/climb
        base: 2800,    // Taxi + Hold + Contingency base
        max_tank: 2500 // Extra fuel if destination is expensive
    };

    let db = [];

    // --- 2. LOAD DATA ---
    window.onload = async () => {
        try {
            const res = await fetch(SHEET_URL);
            const txt = await res.text();
            let rows = txt.split('\n');
            for(let i=1; i<rows.length; i++) {
                let c = rows[i].split(',');
                if(c.length>=3) {
                    let code = c[0].trim().replace(/"/g,"").toUpperCase();
                    let tax = c[3] ? parseFloat(c[3]) : DEFAULT_TAX;
                    if(code) db.push({ code, lat: parseFloat(c[1]), lon: parseFloat(c[2]), tax: isNaN(tax)?DEFAULT_TAX:tax });
                }
            }
            console.log("DB Loaded: " + db.length);
        } catch(e) { console.log("Error loading DB"); }
    };

    // --- 3. SMART SLIDER LOGIC ---
    function updateLabel(val) {
        document.getElementById('fob-val').innerText = val + " kg";
    }

    function autoAdjustSlider() {
        const pCode = document.getElementById('prev').value.toUpperCase();
        const prev = db.find(a => a.code === pCode);
        const CCU_TAX = 25; // Approximate high tax for CCU comparison
        
        if (prev) {
            const slider = document.getElementById('fob');
            const msg = document.getElementById('slider-msg');
            
            // If Origin Tax < CCU Tax (25%), they likely tankered in.
            if (prev.tax < CCU_TAX) {
                slider.value = 5500;
                msg.innerText = `Auto-set: High Fuel (Cheap origin ${pCode})`;
                msg.style.color = "#00b894";
            } else {
                slider.value = 2500;
                msg.innerText = `Auto-set: Low Fuel (Expensive origin ${pCode})`;
                msg.style.color = "#d63031";
            }
            updateLabel(slider.value);
        }
    }

    // --- 4. CALCULATION ---
    function calculate() {
        const nCode = document.getElementById('next').value.toUpperCase();
        const fob = parseInt(document.getElementById('fob').value);
        
        const org = db.find(a => a.code === "CCU"); // Hardcoded CCU Base
        const dst = db.find(a => a.code === nCode);

        if(!org || !dst) { alert("Check Airport Codes"); return; }

        // Distance
        const R = 6371;
        const dLat = (dst.lat - org.lat)*Math.PI/180;
        const dLon = (dst.lon - org.lon)*Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(org.lat*Math.PI/180)*Math.cos(dst.lat*Math.PI/180) * Math.sin(dLon/2)**2;
        const dist = R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));

        // Block Fuel
        let block = (dist * AC.burn) + AC.base;
        
        // Tankering Logic (CCU vs Destination)
        let isTankering = false;
        if (org.tax < dst.tax) {
            block += AC.max_tank;
            isTankering = true;
        }

        block = Math.ceil(block/100)*100; // Round to 100

        let uplift = block - fob;
        if(uplift < 0) uplift = 0;

        // Display
        document.getElementById('result').style.display = 'block';
        document.getElementById('uplift').innerText = uplift.toLocaleString() + " kg";
        document.getElementById('block').innerText = block.toLocaleString();
        document.getElementById('dist').innerText = Math.round(dist);
        document.getElementById('tanker').innerText = isTankering ? "YES" : "NO";
        document.getElementById('tanker').style.color = isTankering ? "#00b894" : "#2d3436";
    }
</script>

</body>
</html>
