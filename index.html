<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>dispatch.io | Real World Ops</title>
    <style>
        :root { --primary: #002b55; --accent: #00a8e8; --bg: #f4f7f6; --safe: #00b894; --warn: #fdcb6e; --danger: #d63031; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; background-color: var(--bg); margin: 0; padding: 20px; color: #2d3436; }
        
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.08); }
        h1 { text-align: center; margin-bottom: 5px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .sub { text-align: center; color: #636e72; font-size: 0.9rem; margin-bottom: 30px; }

        /* Flow Diagram */
        .flow { display: flex; align-items: flex-end; gap: 15px; margin-bottom: 30px; }
        .box { flex: 1; }
        .box label { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; color: #b2bec3; display: block; margin-bottom: 8px;}
        .box input { width: 100%; padding: 15px; text-align: center; font-size: 1.2rem; font-weight: 800; border: 2px solid #dfe6e9; border-radius: 8px; text-transform: uppercase; box-sizing: border-box; color: #2d3436;}
        .box input:focus { border-color: var(--accent); outline: none; background: #f0faff; }
        .arrow { padding-bottom: 20px; color: #dfe6e9; font-size: 1.5rem; }
        
        #curr_stn { border-color: var(--primary); background: #eef5fb; color: var(--primary); }

        button { width: 100%; padding: 18px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: not-allowed; transition: 0.2s; }
        button.active { cursor: pointer; background: var(--safe); box-shadow: 0 4px 15px rgba(0,184,148,0.3); }
        button.active:hover { transform: translateY(-2px); }

        /* Results Panel */
        #result-panel { display: none; margin-top: 40px; }
        
        .hero-section { display: flex; align-items: center; justify-content: space-between; background: var(--primary); color: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; }
        .hero-label { font-size: 0.9rem; opacity: 0.8; text-transform: uppercase; }
        .hero-val { font-size: 3.5rem; font-weight: 800; line-height: 1; }
        .strategy-pill { background: rgba(255,255,255,0.15); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; margin-top: 10px; display: inline-block; }

        .grid { display: grid; grid-template-columns: 1fr 1.2fr; gap: 25px; }
        .card { background: #fff; padding: 20px; border-radius: 12px; border: 1px solid #dfe6e9; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .card-header { font-size: 0.8rem; font-weight: 800; text-transform: uppercase; border-bottom: 2px solid #f1f2f6; padding-bottom: 10px; margin-bottom: 15px; color: #b2bec3; letter-spacing: 0.5px; }

        .data-row { display: flex; justify-content: space-between; font-size: 0.95rem; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #f1f2f6; }
        .data-row:last-child { border: none; }
        .lbl { color: #636e72; }
        .val { font-weight: 700; color: #2d3436; }

        /* Safety Stack Specifics */
        .stack-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 0.9rem; }
        .stack-name { display: flex; align-items: center; gap: 8px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #dfe6e9; }
        .stack-val { font-weight: 700; font-family: 'Consolas', monospace; }
        
        .highlight-row { background: #f0faff; padding: 10px; border-radius: 6px; margin-top: 5px; font-weight: bold; color: var(--primary); }
        
    </style>
</head>
<body>

<div class="container">
    <h1>✈️ Dispatch.io | Pro</h1>
    <p class="sub">Realistic Fuel Planning for A320/B737 Ops</p>
    
    <div id="status" style="text-align:center; font-size:0.8rem; color:#b2bec3; margin-bottom:15px;">⏳ Initializing Nav Database...</div>

    <div class="flow">
        <div class="box">
            <label>Inbound From</label>
            <input type="text" id="prev_stn" placeholder="DEL">
        </div>
        <div class="arrow">➝</div>
        <div class="box">
            <label>Current (Uplift At)</label>
            <input type="text" id="curr_stn" value="CCU">
        </div>
        <div class="arrow">➝</div>
        <div class="box">
            <label>Destination</label>
            <input type="text" id="next_stn" placeholder="BKK">
        </div>
    </div>

    <label style="font-size:0.8rem; font-weight:bold; color:#636e72;">AIRCRAFT CONFIGURATION</label>
    <select id="ac_type" style="width:100%; padding:12px; margin-top:8px; border: 2px solid #dfe6e9; border-radius: 6px; font-weight: 600;">
        <option value="A320">Airbus A320 (Domestic Config)</option>
        <option value="B737">Boeing 737-800 (Domestic Config)</option>
        <option value="B777">Boeing 777-300ER (Long Haul)</option>
    </select>

    <button id="calc-btn" onclick="calculate()" disabled>Waiting for Database...</button>

    <div id="result-panel">
        <div class="hero-section">
            <div>
                <div class="hero-label">Total Fuel Required (FOB)</div>
                <div id="strategy-pill" class="strategy-pill">Analyzing Strategy...</div>
            </div>
            <div id="final-uplift" class="hero-val">0 kg</div>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-header">1. Inbound Status</div>
                <div class="data-row">
                    <span class="lbl">Inbound From:</span>
                    <span id="lbl-prev" class="val">XXX</span>
                </div>
                <div class="data-row">
                    <span class="lbl">Price @ Origin:</span>
                    <span id="price-prev" class="val">-</span>
                </div>
                <div class="data-row">
                    <span class="lbl">Est. Arrival Fuel:</span>
                    <span id="arr-fuel" class="val">0 kg</span>
                </div>
                <p id="arr-msg" style="font-size:0.8rem; color:#b2bec3; margin-top:15px; font-style:italic; line-height:1.4;">...</p>
            </div>

            <div class="card">
                <div class="card-header">2. Departure Build-up</div>
                
                <div class="stack-row">
                    <div class="stack-name"><div class="dot" style="background:#0984e3"></div>Trip Fuel</div>
                    <div id="s-trip" class="stack-val">0</div>
                </div>
                <div class="stack-row">
                    <div class="stack-name"><div class="dot" style="background:#00cec9"></div>Taxi Fuel</div>
                    <div id="s-taxi" class="stack-val">0</div>
                </div>
                <div class="stack-row">
                    <div class="stack-name"><div class="dot" style="background:#fdcb6e"></div>Contingency (5%)</div>
                    <div id="s-cont" class="stack-val">0</div>
                </div>
                 <div class="stack-row">
                    <div class="stack-name"><div class="dot" style="background:#e17055"></div>Alternate (<span id="alt-code">...</span>)</div>
                    <div id="s-alt" class="stack-val">0</div>
                </div>
                 <div class="stack-row">
                    <div class="stack-name"><div class="dot" style="background:#d63031"></div>Final Reserve</div>
                    <div id="s-res" class="stack-val">0</div>
                </div>
                <div class="stack-row">
                    <div class="stack-name"><div class="dot" style="background:#6c5ce7"></div>Cmdr. Extra</div>
                    <div id="s-extra" class="stack-val">0</div>
                </div>

                <div class="highlight-row stack-row">
                    <div class="stack-name">MIN BLOCK FUEL</div>
                    <div id="s-total" class="stack-val">0 kg</div>
                </div>

                <div style="margin-top:15px; font-size:0.85rem; color:#636e72; border-top:1px solid #f1f2f6; padding-top:10px;">
                    Tankering Add: <strong id="tanker-add" style="color:var(--safe)">0 kg</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- 1. CONFIG & TUNED CONSTANTS ---
    const SHEET_URL = "airports.csv"; 
    const BASE_PRICE = 90; 
    const DEFAULT_TAX = 4;

    // TUNED FOR REALISM (Higher Burn for Climb/Drag + Ground Ops)
    const acSpecs = {
        "A320": { 
            burn: 3.6,        // Increased from 2.8 to account for climb/payload
            taxi: 250,        // Standard Taxi
            hold: 1500,       // Final Reserve (30 min @ 1500ft)
            extra: 500,       // Captain's Discretion
            max_tanker: 3000 
        },
        "B737": { 
            burn: 3.4, 
            taxi: 250, 
            hold: 1400, 
            extra: 500,
            max_tanker: 3000 
        },
        "B777": { 
            burn: 8.0, 
            taxi: 600, 
            hold: 4000, 
            extra: 1000,
            max_tanker: 15000 
        }
    };

    let airportData = [];

    // --- 2. LOADER ---
    window.onload = async () => {
        const msg = document.getElementById('status');
        const btn = document.getElementById('calc-btn');
        try {
            const res = await fetch(SHEET_URL);
            if(!res.ok) throw new Error("CSV not found");
            const txt = await res.text();
            if(txt.startsWith("<")) throw new Error("Not a CSV");
            
            parseCSV(txt);
            
            if(airportData.length > 0){
                msg.innerHTML = `<span style="color:green">✅ Database Online (${airportData.length} airports)</span>`;
                btn.disabled = false;
                btn.className = "active";
                btn.innerText = "CALCULATE REAL FUEL";
            }
        } catch(e) { msg.innerText = "Error: " + e.message; msg.style.color = "red"; }
    };

    function parseCSV(txt) {
        const rows = txt.split('\n');
        for (let i = 1; i < rows.length; i++) {
            let cols = rows[i].split(',');
            if (cols.length >= 3) {
                let code = cols[0].trim().replace(/"/g, "").toUpperCase();
                let tax = cols[3] ? parseFloat(cols[3]) : DEFAULT_TAX;
                if(isNaN(tax)) tax = DEFAULT_TAX;
                if(code) airportData.push({ code, lat: parseFloat(cols[1]), lon: parseFloat(cols[2]), tax });
            }
        }
    }

    // --- 3. MATH UTILS ---
    function getDist(p1, p2) {
        const R = 6371;
        const dLat = (p2.lat - p1.lat) * Math.PI/180;
        const dLon = (p2.lon - p1.lon) * Math.PI/180;
        const a = Math.sin(dLat/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180) * Math.sin(dLon/2)**2;
        return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    function findAlternate(destNode) {
        let nearest = null;
        let minDist = Infinity;
        airportData.forEach(stn => {
            if (stn.code !== destNode.code) {
                let d = getDist(destNode, stn);
                if (d < minDist) { minDist = d; nearest = stn; }
            }
        });
        return { stn: nearest, dist: minDist };
    }

    // --- 4. CORE CALCULATION ---
    function calculate() {
        const pCode = document.getElementById('prev_stn').value.toUpperCase().trim();
        const cCode = document.getElementById('curr_stn').value.toUpperCase().trim();
        const nCode = document.getElementById('next_stn').value.toUpperCase().trim();
        const ac = acSpecs[document.getElementById('ac_type').value];

        const prev = airportData.find(a => a.code === pCode);
        const curr = airportData.find(a => a.code === cCode);
        const next = airportData.find(a => a.code === nCode);

        if (!prev || !curr || !next) { alert("Airport not found."); return; }

        // Prices
        const pPrev = BASE_PRICE + (BASE_PRICE * prev.tax / 100);
        const pCurr = BASE_PRICE + (BASE_PRICE * curr.tax / 100);
        const pNext = BASE_PRICE + (BASE_PRICE * next.tax / 100);

        // --- INBOUND LOGIC (Arrival) ---
        let arrFuel = 0;
        let arrMsg = "";
        
        // If we came from a cheap place, assume we brought extra. 
        // If expensive, assume we landed with Reserves + Extra only.
        if (pPrev < pCurr) {
            arrFuel = ac.hold + ac.extra + ac.max_tanker; 
            arrMsg = `Tankered in from ${pCode} (Cheap). Heavy Arrival.`;
        } else {
            arrFuel = ac.hold + ac.extra; 
            arrMsg = `Standard Arrival from ${pCode}.`;
        }

        // --- OUTBOUND LOGIC (The Stack) ---
        
        // 1. Trip Fuel (Increased Burn Rate)
        const distTrip = getDist(curr, next);
        const fuelTrip = Math.round(distTrip * ac.burn);

        // 2. Taxi Fuel (Fixed)
        const fuelTaxi = ac.taxi;

        // 3. Contingency (5% of Trip)
        const fuelCont = Math.round(fuelTrip * 0.05);

        // 4. Alternate Fuel
        const altData = findAlternate(next);
        let fuelAlt = 0;
        let altCode = "NONE";
        if (altData.stn) {
            fuelAlt = Math.round(altData.dist * ac.burn);
            altCode = altData.stn.code;
        }

        // 5. Final Reserve (Holding)
        const fuelRes = ac.hold;

        // 6. Commander's Extra (Buffer)
        const fuelExtra = ac.extra;

        // TOTAL MINIMUM BLOCK FUEL
        const minBlockFuel = fuelTrip + fuelTaxi + fuelCont + fuelAlt + fuelRes + fuelExtra;

        // --- FINANCIAL LOGIC ---
        let tankerAdd = 0;
        if (pCurr < pNext) {
            tankerAdd = ac.max_tanker; // It's cheap here!
            document.getElementById('strategy-pill').innerText = "TANKERING RECOMMENDED";
            document.getElementById('strategy-pill').style.background = "#00b894";
        } else {
            tankerAdd = 0;
            document.getElementById('strategy-pill').innerText = "MINIMUM FUEL ADVISED";
            document.getElementById('strategy-pill').style.background = "#e17055";
        }

        const targetFOB = minBlockFuel + tankerAdd;
        
        // --- UPLIFT ---
        let uplift = targetFOB - arrFuel;
        if (uplift < 0) uplift = 0;

        // --- UI UPDATE ---
        document.getElementById('result-panel').style.display = "block";
        document.getElementById('final-uplift').innerText = uplift.toLocaleString() + " kg";
        
        // Arrival Card
        document.getElementById('lbl-prev').innerText = pCode;
        document.getElementById('price-prev').innerText = "₹" + pPrev.toFixed(0);
        document.getElementById('arr-fuel').innerText = arrFuel.toLocaleString() + " kg";
        document.getElementById('arr-msg').innerText = arrMsg;

        // Departure Stack
        document.getElementById('s-trip').innerText = fuelTrip.toLocaleString();
        document.getElementById('s-taxi').innerText = fuelTaxi.toLocaleString();
        document.getElementById('s-cont').innerText = fuelCont.toLocaleString();
        document.getElementById('alt-code').innerText = altCode;
        document.getElementById('s-alt').innerText = fuelAlt.toLocaleString();
        document.getElementById('s-res').innerText = fuelRes.toLocaleString();
        document.getElementById('s-extra').innerText = fuelExtra.toLocaleString();
        
        document.getElementById('s-total').innerText = minBlockFuel.toLocaleString() + " kg";
        document.getElementById('tanker-add').innerText = "+ " + tankerAdd.toLocaleString() + " kg";
    }
</script>

</body>
</html>
